services:
  web:
    build:
      context: .
      dockerfile: ./docker/common/nginx/dockerfile
    volumes:
      # Development: Mount source code for live updates
      - ./public:/var/www/public:ro
      - laravel-storage-dev:/var/www/storage:ro
      - ./docker/common/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - laravel-dev
    ports:
      - "8080:80"
    depends_on:
      - php-fpm

  php-fpm:
    build:
      context: .
      dockerfile: ./docker/development/php-fpm/dockerfile
      target: development
    volumes:
      # Mount entire codebase for hot-reloading
      - .:/var/www
      - laravel-storage-dev:/var/www/storage
      # Exclude vendor and node_modules from host
      - /var/www/vendor
      - /var/www/node_modules
    env_file:
      - .env.dev
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - XDEBUG_MODE=develop,debug
      - XDEBUG_CONFIG=client_host=host.docker.internal
    networks:
      - laravel-dev
      - axia-shared-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  php-cli:
    build:
      context: .
      dockerfile: ./docker/development/php-fpm/dockerfile
      target: development
    tty: true
    stdin_open: true
    volumes:
      - .:/var/www
      - /var/www/vendor
      - /var/www/node_modules
    env_file:
      - .env.dev
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
    networks:
      - laravel-dev

  postgres:
    image: postgres:16
    user: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE:-axia_dev}
      - POSTGRES_USER=${POSTGRES_USERNAME:-axia}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secret}
    volumes:
      - postgres-data-dev:/var/lib/postgresql/data
    networks:
      - laravel-dev
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    networks:
      - laravel-dev
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 3

  # Vite development server for hot module replacement
  vite:
    image: node:20-alpine
    working_dir: /var/www
    volumes:
      - .:/var/www
      - /var/www/node_modules
    command: npm run dev
    ports:
      - "5173:5173"
    networks:
      - laravel-dev
    environment:
      - VITE_HOST=0.0.0.0
      - VITE_PORT=5173

  # MailHog for testing emails locally
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Web UI
    networks:
      - laravel-dev

networks:
  laravel-dev:
    driver: bridge
  axia-shared-network:
    external: true

volumes:
  postgres-data-dev:
  laravel-storage-dev:
