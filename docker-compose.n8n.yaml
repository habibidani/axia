services:
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    depends_on:
      n8n-postgres:
        condition: service_healthy
      mcp-duckduckgo:
        condition: service_started
      mcp-notion:
        condition: service_started
      mcp-axia:
        condition: service_started
    ports:
      - "5678:5678"
    environment:
      TZ: Europe/Berlin
      GENERIC_TIMEZONE: Europe/Berlin
      N8N_HOST: n8n.getaxia.de
      N8N_PROTOCOL: https
      WEBHOOK_URL: https://n8n.getaxia.de/
      N8N_PROXY_HOPS: "1"
      N8N_SECURE_COOKIE: "true"
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"
      N8N_RUNNERS_ENABLED: "true"
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n-postgres
      DB_POSTGRESDB_PORT: "5432"
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: ${N8N_DB_PASSWORD:?set in .env}
      DB_POSTGRESDB_SCHEMA: public
      DB_POSTGRESDB_POOL_MAX: "10"
      DB_POSTGRESDB_POOL_MIN: "2"
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: "true"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-datasets:/data/datasets
    networks:
      - n8n-network
      - axia-shared-network
    restart: unless-stopped

  n8n-postgres:
    image: postgres:16-alpine
    container_name: n8n-postgres
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: ${N8N_DB_PASSWORD:?set in .env}
    volumes:
      - n8n_pg_data:/var/lib/postgresql/data
    networks:
      - n8n-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n -d n8n"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  # DuckDuckGo MCP via supergateway (SSE)
  mcp-duckduckgo:
    image: supercorp/supergateway:uvx
    container_name: mcp-duckduckgo
    command: 
      - "--stdio"
      - "uvx -q duckduckgo-mcp-server"
      - "--outputTransport"
      - "sse"
      - "--ssePath"
      - "/sse-duckduckgo"
      - "--baseUrl"
      - "http://0.0.0.0:8100"
      - "--port"
      - "8100"
      - "--cors"
    ports:
      - "8100:8100"
    networks:
      - n8n-network
    restart: unless-stopped

  # Notion MCP Server (SSE)
  mcp-notion:
    image: supercorp/supergateway:uvx
    container_name: mcp-notion
    command:
      - "--stdio"
      - "uvx -q notion-mcp"
      - "--outputTransport"
      - "sse"
      - "--ssePath"
      - "/sse-notion"
      - "--baseUrl"
      - "http://0.0.0.0:8101"
      - "--port"
      - "8101"
      - "--cors"
    environment:
      NOTION_TOKEN: ${NOTION_TOKEN:?set in .env}
    ports:
      - "8101:8101"
    networks:
      - n8n-network
    restart: unless-stopped

  # Axia MCP Server (SSE wie Notion!)
  mcp-axia:
    image: supercorp/supergateway:uvx
    container_name: mcp-axia
    command:
      - "--stdio"
      - "node /app/mcp-server/index.js"
      - "--outputTransport"
      - "sse"
      - "--ssePath"
      - "/sse-axia"
      - "--baseUrl"
      - "http://0.0.0.0:8102"
      - "--port"
      - "8102"
      - "--cors"
    environment:
      AXIA_API_URL: http://axia-web-1/api
      AXIA_API_TOKEN: ${AXIA_API_TOKEN:?set in .env}
    volumes:
      - ./mcp-server:/app/mcp-server:ro
      - ./package.json:/app/package.json:ro
      - ./node_modules:/app/node_modules:ro
    ports:
      - "8102:8102"
    networks:
      - n8n-network
      - axia-shared-network
    restart: unless-stopped

networks:
  n8n-network:
    driver: bridge
  axia-shared-network:
    external: true

volumes:
  n8n_data:
  n8n_pg_data:
